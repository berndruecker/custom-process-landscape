<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Process Landscape POC</title>

  <!-- viewer distro (without pan and zoom) -->
  <!--
  <script src="https://unpkg.com/bpmn-js@13.2.2/dist/bpmn-viewer.development.js"></script>
  -->

  <!-- required viewer styles -->
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@13.2.2/dist/assets/bpmn-js.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

  <!-- viewer distro (with pan and zoom) -->
  <script src="https://unpkg.com/bpmn-js@13.2.2/dist/bpmn-navigated-viewer.development.js"></script>

  <!-- JQuery -->
  <script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>

  <!-- example styles -->
  <style>
      html, body, #canvas {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      .diagram-note {
        background-color: rgba(66, 180, 21, 0.7);
        color: White;
        border-radius: 5px;
        font-family: Arial;
        font-size: 12px;
        padding: 5px;
        min-height: 16px;
        width: max-content;
      }

      .highlight:not(.djs-connection) .djs-visual > :nth-child(1) {
        fill: yellow !important;
      }
    </style>
</head>
<body>
  <div>
    <h1>Top level processes / value streams in project</h1>
    <ul id="topLevelProcesses">
    </ul>
  </div>
  <div>
    <h1>Selected Process</h1>
    <h4 id="processName"></h4>
    Parent: <a id="parentProcess" href="#"></a>
    <div id="bpmnjs"></div>
  </div>
  <div>
    <h1>Details</h1>
    <div id="details"></div>
  </div>
<script>

  function loadTopLevelProcesses() {
    $.get("http://localhost:8080/processes", function(data, status){
      console.log(data);

      $.each(data, function(index, value) {
        console.log(value);
        $("#topLevelProcesses").append("<li><a id='"+value.id+"' href='#' >" + value.name + "</a></li>");
        $("#"+value.id).click(function() {
          selectProcess(value);
        });
      });

    });
  }

  function loadProcess(processId, callback) {
    $.get("http://localhost:8080/processes/" + processId, function(data, status){
      console.log(data);
      selectProcess(data, callback);
    });
  }

  function selectProcess(process, callback) {
       $("#processName").text(process.name);
       if (process.parentProcessId) {
         $("#parentProcess").text(process.parentProcessName ? process.parentProcessName : process.parentProcessId);
         $("#parentProcess").click(function() {
            loadProcess(process.parentProcessId);
         });
       }
       $("#details").empty();
       loadDiagram(process, callback);
  }

  // viewer instance
  var bpmnViewer = new BpmnJS({
    container: '#bpmnjs'
  });


  function loadDiagram(process, callback) {

        var diagramUrl = 'http://localhost:8080/processes/' + process.id + '/xml';

        /**
         * Open diagram in our viewer instance.
         */
        async function openDiagram(bpmnXML) {
          // import diagram
          try {
            await bpmnViewer.importXML(bpmnXML);

            // add additional information as overlay
            var canvas = bpmnViewer.get('canvas');
            var overlays = bpmnViewer.get('overlays');

            // zoom to fit full viewport
            canvas.zoom('fit-viewport');

            addOverlaysServiceTask(overlays, process);
            addOverlaysCallActivities(overlays, process);
            addOverlaysUserTasks(overlays, process);

            if (callback) {
              callback();
            }

          } catch (err) {
            console.error('could not import BPMN 2.0 diagram', err);
          }
        }

        // load external diagram file via AJAX and open it
        $.get(diagramUrl, openDiagram, 'text');
  }

  function addOverlaysServiceTask(overlays, process) {
     process.serviceTasks.forEach( task => {
        var overlayHtml = $('<div class="diagram-note"><a href="#" id="link_task_'+task.id+'">' + task.system + '</a></div>');
        overlays.add(task.id, 'SERVICE', {
              position: {
                bottom: 0,
                left: 0
              },
              html: overlayHtml
        });
        $("#link_task_"+task.id).click(function() {
          loadSystem(task.system);
        });
     });
   }

   function loadSystem(systemId) {
        $("#details").empty();

        $("#details").append("<h2>System: " + systemId + "</h2>");
        $("#details").append("<h2>Used in: </h2>");
        $("#details").append("<ul id='usedIn'></ul>");
        $.get("http://localhost:8080/systems/" + systemId + "/usage", function(data, status){
          console.log(data);
          $.each(data, function(index, value) {
            console.log(value);
            var element = $("#usedIn").append("<li><a id='link_system_process_"+value.processId+"' href='#'>" + value.processName + " -> " + value.name + "</a></li>");
            element.click(function() {
              loadProcess(value.processId, function() {
                bpmnViewer.get('canvas').addMarker(value.id, 'highlight');
              });
            });
          });
        });
   }

   function addOverlaysCallActivities(overlays, process) {
       process.callActivities.forEach( task => {
           var overlayHtml = $('<div class="diagram-note"><ul></ul></div>');
           if (task.calledProcesses) {
             for (const calledProcess of task.calledProcesses) {
                  overlayHtml.append("<li><a id='link_process_"+calledProcess.id+"' href='#'>" + calledProcess.variant + ": " + calledProcess.name + "</a></li>");
             }
           }
           overlays.add(task.id, 'CALL', {
                  position: {
                    bottom: 0,
                    left: 0
                  },
                  html: overlayHtml
           });
           // Need to do this after the element has really been added to HTML
           if (task.calledProcesses) {
             for (const calledProcess of task.calledProcesses) {
                  $("#link_process_"+calledProcess.id).click(function() {
                    loadProcess(calledProcess.id);
                  });
             }
           }

       });
  }

  function addOverlaysUserTasks(overlays, process) {
     process.userTasks.forEach( task => {
        var overlayHtml = $('<div class="diagram-note"><a href="#" id="link_task_'+task.id+'">' + task.assignment + '</a></div>');
        overlays.add(task.id, 'SERVICE', {
              position: {
                bottom: 0,
                left: 0
              },
              html: overlayHtml
        });
        $("#link_task_"+task.id).click(function() {
          loadAssignment(task.assignment);
        });
     });
   }

   function loadAssignment(assignment) {
        $("#details").empty();

        $("#details").append("<h2>User/group: " + assignment + "</h2>");
        $("#details").append("<h2>Also doing: </h2>");
        $("#details").append("<ul id='usedIn'></ul>");
        $.get("http://localhost:8080/users/" + assignment + "/usage", function(data, status){
          console.log(data);
          $.each(data, function(index, value) {
            console.log(value);
            var element = $("#usedIn").append("<li><a id='link_assignment_process_"+value.processId+"' href='#'>" + value.processName + " -> " + value.name + "</a></li>");
            element.click(function() {
              loadProcess(value.processId, function() {
                bpmnViewer.get('canvas').addMarker(value.id, 'highlight');
              });
            });
          });
        });
   }


  loadTopLevelProcesses();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

</body>
</html>